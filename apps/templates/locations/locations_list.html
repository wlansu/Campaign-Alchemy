<script>
  function getFeature(featureID) {
    return data.features.find(({id}) => id === featureID)
  }

  function openEditModal(featureID) {
    map.closePopup()
    const feature = getFeature(featureID);
    const { updateURL, longitude, latitude } = feature.properties
    fetch(updateURL).then(response => {
      return response.text()
    }).then(newHTML => {
      document.getElementById("dialog").innerHTML = newHTML
      document.getElementById("id_latitude").value = latitude
      document.getElementById("id_longitude").value = longitude
    })
    modal.show()
  }

  function deleteLocation(featureID) {
    map.closePopup()
    const feature = getFeature(featureID)
    const deleteURL = feature.properties.deleteURL
    fetch(deleteURL).then(response => {
      return response.text()
    }).then(newHTML => {
      document.getElementById("dialog").innerHTML = newHTML
    })
    modal.show()
  }

  let data = {
    "type": "FeatureCollection",
    "features": [],
  }
  {% for location in locations %}
    data.features.push({
      "type": "Feature",
      "id": "{{ location.id }}",
      "geometry": {
        "type": "Point",
        "coordinates": ["{{ location.longitude }}", "{{ location.latitude }}"] {# Coordinates here need to be reversed. #}
      },
      "properties": {
        "name": "{{ location.name }}",
        "description": "{{ location.description }}",
        "latitude": "{{ location.latitude }}",
        "longitude": "{{ location.longitude }}",
        "updateURL": "{% url 'campaigns:maps:locations:update' campaign_pk=location.map.campaign.id map_pk=location.map.id location_pk=location.id %}",
        "deleteURL": "{% url 'campaigns:maps:locations:delete' campaign_pk=location.map.campaign.id map_pk=location.map.id location_pk=location.id %}"
      }
    })
  {% endfor %}
  L.geoJSON(data, {
    onEachFeature: function(feature, layer) {
      layer.bindPopup(
        feature.properties.name +
        '<br />' + feature.properties.description +
        '<br />' + '<button class="btn btn-primary" type="button" onclick="openEditModal(\'' + feature.id + '\')">Edit</button>' +
        '<br />' + '<button class="btn btn-warning" type="button" onclick="deleteLocation(\'' + feature.id + '\')">Delete</button>')

    }
  }).addTo(map)
</script>
