{% load static bleach_tags %}
{% for location in locations %}
  <div class="row mb-3 dark-color-scheme rounded-2 ca-pointer" hx-get="{% url 'campaigns:maps:locations:detail' campaign_pk=location.map.campaign.id map_pk=location.map.id location_pk=location.id %}" hx-trigger="click" hx-target="#dialog">
    <div class="col-4 mt-2">
      <img src="{% if location.image %}{{ location.image.url }}{% else %}{% static 'images/default_location.jpg' %}{% endif %}" alt="Image of {{ location.name }}" class="img-fluid">
    </div>
    <div class="col-8">
      <h4>{{ location.name }}</h4>
      <p>{{ location.description|bleach|truncatewords_html:25 }}</p>
    </div>
  </div>
{% endfor %}
{% block inline_javascript %}
<script>
  function addMarkersToMap(data) {
    L.geoJSON(data, {
      onEachFeature: function (feature, layer) {
        layer.on("click", (e) => {
          let dialog = htmx.find("#dialog")
          fetch(feature.properties.detailUrl).then(response => {
            return response.text()
          }).then(newHTML => {
            dialog.innerHTML = newHTML
            htmx.process(dialog)
          })
          modal.show()
        })
      }
    }).addTo(map)
  }

  try {
    let data = {
      "type": "FeatureCollection",
      "features": [],
    }
    {# Loop over locations and add them to a FeatureCollection which is then used to build the markers on the map. #}
    {% for location in locations %}
      data.features.push({
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": ["{{ location.longitude }}", "{{ location.latitude }}"] {# Coordinates here need to be reversed. #}
        },
        "properties": {
          "detailUrl": "{% url 'campaigns:maps:locations:detail' campaign_pk=location.map.campaign.id map_pk=location.map.id location_pk=location.id %}",
        }
      })
    {% endfor %}
    addMarkersToMap(data)
  } catch (error) {
    console.log(error)
  }


</script>
{% endblock %}
